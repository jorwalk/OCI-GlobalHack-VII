{"version":3,"sources":["public/src/client/groups/memberlist.js"],"names":["define","autocomplete","MemberList","searchInterval","groupName","templateName","init","_templateName","ajaxify","data","group","name","handleMemberAdd","handleMemberSearch","handleMemberInfiniteScroll","$","on","modal","bootbox","dialog","title","message","user","find","ev","ui","item","addUserToGroup","callback","socket","emit","uid","err","app","alertError","parseAndTranslate","html","prepend","query","this","val","clearInterval","setTimeout","results","users","attr","$this","bottom","scrollHeight","innerHeight","scrollTop","loadMoreMembers","members","after","length","onMembersLoaded","removeAttr","nextStart","filter","append","isOwner"],"mappings":"AAAA,aAGAA,OAAO,2BAA4B,gBAAiB,SAAUC,GAC7D,IAAIC,KACJ,IAAIC,EACJ,IAAIC,EACJ,IAAIC,EAEJH,EAAWI,KAAO,SAAUC,GAC3BF,EAAeE,GAAiB,iBAChCH,EAAYI,QAAQC,KAAKC,MAAMC,KAE/BC,IACAC,IACAC,KAGD,SAASF,IACRG,EAAE,oCAAoCC,GAAG,QAAS,WACjD,IAAIC,EAAQC,QAAQC,QACnBC,MAAO,gCACPC,QAAS,8EAEVpB,EAAaqB,KAAKL,EAAMM,KAAK,SAAU,SAAUC,EAAIC,GACpD,IAAIH,EAAOG,EAAGC,KAAKJ,KACnB,GAAIA,EAAM,CACTK,EAAeL,EAAM,WACpBL,EAAMA,MAAM,eAOjB,SAASU,EAAeL,EAAMM,GAC7BC,OAAOC,KAAK,oBAAsB1B,UAAWA,EAAW2B,IAAKT,EAAKS,KAAO,SAAUC,GAClF,GAAIA,EAAK,CACR,OAAOC,IAAIC,WAAWF,GAEvBG,GAAmBb,GAAO,SAAUc,GACnCrB,EAAE,sCAAsCsB,QAAQD,KAEjDR,MAIF,SAASf,IACRE,EAAE,uCAAuCC,GAAG,QAAS,WACpD,IAAIsB,EAAQvB,EAAEwB,MAAMC,MACpB,GAAIrC,EAAgB,CACnBsC,cAActC,GACdA,EAAiB,EAGlBA,EAAiBuC,WAAW,WAC3Bb,OAAOC,KAAK,wBAA0B1B,UAAWA,EAAWkC,MAAOA,GAAS,SAAUN,EAAKW,GAC1F,GAAIX,EAAK,CACR,OAAOC,IAAIC,WAAWF,EAAIX,SAE3Bc,EAAkBQ,EAAQC,MAAO,SAAUR,GAC1CrB,EAAE,sCAAsCqB,KAAKA,GAC7CrB,EAAE,gCAAgC8B,KAAK,iBAAkB,SAGzD,OAIL,SAAS/B,IACRC,EAAE,sCAAsCC,GAAG,SAAU,WACpD,IAAI8B,EAAQ/B,EAAEwB,MACd,IAAIQ,GAAUD,EAAM,GAAGE,aAAeF,EAAMG,eAAiB,GAE7D,GAAIH,EAAMI,YAAcH,IAAWhC,EAAE,uCAAuCyB,MAAO,CAClFW,OAKH,SAASA,IACR,IAAIC,EAAUrC,EAAE,gCAChB,GAAIqC,EAAQP,KAAK,WAAY,CAC5B,OAGDO,EAAQP,KAAK,UAAW,GACxBhB,OAAOC,KAAK,0BACX1B,UAAWA,EACXiD,MAAOD,EAAQP,KAAK,mBAClB,SAAUb,EAAKvB,GACjB,GAAIuB,EAAK,CACR,OAAOC,IAAIC,WAAWF,EAAIX,SAG3B,GAAIZ,GAAQA,EAAKmC,MAAMU,OAAQ,CAC9BC,EAAgB9C,EAAKmC,MAAO,WAC3BQ,EAAQI,WAAW,WACnBJ,EAAQP,KAAK,iBAAkBpC,EAAKgD,iBAE/B,CACNL,EAAQI,WAAW,cAKtB,SAASD,EAAgBX,EAAOhB,GAC/BgB,EAAQA,EAAMc,OAAO,SAAUpC,GAC9B,OAAQP,EAAE,2CAA6CO,EAAKS,IAAM,MAAMuB,SAGzEnB,EAAkBS,EAAO,SAAUR,GAClCrB,EAAE,sCAAsC4C,OAAOvB,GAC/CR,MAIF,SAASO,EAAkBS,EAAOhB,GACjCK,IAAIE,kBAAkB9B,EAAc,iBACnCK,OACC0C,QAASR,EACTgB,QAASpD,QAAQC,KAAKC,MAAMkD,UAE3BhC,GAGJ,OAAO1B","file":"public/src/client/groups/memberlist.js","sourcesContent":["'use strict';\n\n\ndefine('forum/groups/memberlist', ['autocomplete'], function (autocomplete) {\n\tvar MemberList = {};\n\tvar searchInterval;\n\tvar groupName;\n\tvar templateName;\n\n\tMemberList.init = function (_templateName) {\n\t\ttemplateName = _templateName || 'groups/details';\n\t\tgroupName = ajaxify.data.group.name;\n\n\t\thandleMemberAdd();\n\t\thandleMemberSearch();\n\t\thandleMemberInfiniteScroll();\n\t};\n\n\tfunction handleMemberAdd() {\n\t\t$('[component=\"groups/members/add\"]').on('click', function () {\n\t\t\tvar modal = bootbox.dialog({\n\t\t\t\ttitle: '[[groups:details.add-member]]',\n\t\t\t\tmessage: '<input class=\"form-control\" type=\"text\" placeholder=\"[[global:search]]\"/>',\n\t\t\t});\n\t\t\tautocomplete.user(modal.find('input'), function (ev, ui) {\n\t\t\t\tvar user = ui.item.user;\n\t\t\t\tif (user) {\n\t\t\t\t\taddUserToGroup(user, function () {\n\t\t\t\t\t\tmodal.modal('hide');\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tfunction addUserToGroup(user, callback) {\n\t\tsocket.emit('groups.addMember', { groupName: groupName, uid: user.uid }, function (err) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err);\n\t\t\t}\n\t\t\tparseAndTranslate([user], function (html) {\n\t\t\t\t$('[component=\"groups/members\"] tbody').prepend(html);\n\t\t\t});\n\t\t\tcallback();\n\t\t});\n\t}\n\n\tfunction handleMemberSearch() {\n\t\t$('[component=\"groups/members/search\"]').on('keyup', function () {\n\t\t\tvar query = $(this).val();\n\t\t\tif (searchInterval) {\n\t\t\t\tclearInterval(searchInterval);\n\t\t\t\tsearchInterval = 0;\n\t\t\t}\n\n\t\t\tsearchInterval = setTimeout(function () {\n\t\t\t\tsocket.emit('groups.searchMembers', { groupName: groupName, query: query }, function (err, results) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t}\n\t\t\t\t\tparseAndTranslate(results.users, function (html) {\n\t\t\t\t\t\t$('[component=\"groups/members\"] tbody').html(html);\n\t\t\t\t\t\t$('[component=\"groups/members\"]').attr('data-nextstart', 20);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}, 250);\n\t\t});\n\t}\n\n\tfunction handleMemberInfiniteScroll() {\n\t\t$('[component=\"groups/members\"] tbody').on('scroll', function () {\n\t\t\tvar $this = $(this);\n\t\t\tvar bottom = ($this[0].scrollHeight - $this.innerHeight()) * 0.9;\n\n\t\t\tif ($this.scrollTop() > bottom && !$('[component=\"groups/members/search\"]').val()) {\n\t\t\t\tloadMoreMembers();\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction loadMoreMembers() {\n\t\tvar members = $('[component=\"groups/members\"]');\n\t\tif (members.attr('loading')) {\n\t\t\treturn;\n\t\t}\n\n\t\tmembers.attr('loading', 1);\n\t\tsocket.emit('groups.loadMoreMembers', {\n\t\t\tgroupName: groupName,\n\t\t\tafter: members.attr('data-nextstart'),\n\t\t}, function (err, data) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tif (data && data.users.length) {\n\t\t\t\tonMembersLoaded(data.users, function () {\n\t\t\t\t\tmembers.removeAttr('loading');\n\t\t\t\t\tmembers.attr('data-nextstart', data.nextStart);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tmembers.removeAttr('loading');\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction onMembersLoaded(users, callback) {\n\t\tusers = users.filter(function (user) {\n\t\t\treturn !$('[component=\"groups/members\"] [data-uid=\"' + user.uid + '\"]').length;\n\t\t});\n\n\t\tparseAndTranslate(users, function (html) {\n\t\t\t$('[component=\"groups/members\"] tbody').append(html);\n\t\t\tcallback();\n\t\t});\n\t}\n\n\tfunction parseAndTranslate(users, callback) {\n\t\tapp.parseAndTranslate(templateName, 'group.members', {\n\t\t\tgroup: {\n\t\t\t\tmembers: users,\n\t\t\t\tisOwner: ajaxify.data.group.isOwner,\n\t\t\t},\n\t\t}, callback);\n\t}\n\n\treturn MemberList;\n});\n"]}