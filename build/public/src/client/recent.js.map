{"version":3,"sources":["public/src/client/recent.js"],"names":["define","infinitescroll","components","handleBack","Recent","newTopicCount","newPostCount","$","window","on","ev","data","ajaxify","currentPage","url","removeListeners","init","app","enterRoom","watchForNewPosts","handleCategorySelection","after","cb","loadTopicsAfter","this","addClass","config","usePagination","loadMoreTopics","trigger","topics","socket","onNewTopic","onNewPost","selectedCids","indexOf","parseInt","cid","selectedFilter","filter","template","category","updateAlertText","showAlert","post","posts","topic","mainPid","pid","emit","tid","err","isFollowed","alertError","message","getSelectedCids","cids","each","index","el","find","length","push","attr","sort","a","b","changed","forEach","location","pathname","currentParams","utils","params","decodeURIComponent","param","go","selectChildren","parentCid","flag","toggleClass","categoryEl","ctrlKey","hasClass","first","removeListener","text","translateText","removeClass","fadeIn","direction","afterEl","last","callback","loadMore","count","topicsPerPage","set","done","onTopicsLoaded","nextStart","templateName","showSelect","get","before","topicsList","parseAndTranslate","html","remove","insertAfter","height","document","scrollTop","insertBefore","append","timeago","createUserTooltips","makeNumbersHumanReadable"],"mappings":"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","file":"public/src/client/recent.js","sourcesContent":["'use strict';\n\ndefine('forum/recent', ['forum/infinitescroll', 'components', 'handleBack'], function (infinitescroll, components, handleBack) {\n\tvar\tRecent = {};\n\n\tvar newTopicCount = 0;\n\tvar newPostCount = 0;\n\n\t$(window).on('action:ajaxify.start', function (ev, data) {\n\t\tif (ajaxify.currentPage !== data.url) {\n\t\t\tRecent.removeListeners();\n\t\t}\n\t});\n\n\tRecent.init = function () {\n\t\tapp.enterRoom('recent_topics');\n\n\t\tRecent.watchForNewPosts();\n\n\t\tRecent.handleCategorySelection();\n\n\t\thandleBack.init(function (after, cb) {\n\t\t\tloadTopicsAfter(after, 1, cb);\n\t\t});\n\n\t\t$('#new-topics-alert').on('click', function () {\n\t\t\t$(this).addClass('hide');\n\t\t});\n\n\t\tif (!config.usePagination) {\n\t\t\tinfinitescroll.init(Recent.loadMoreTopics);\n\t\t}\n\n\t\t$(window).trigger('action:topics.loaded', { topics: ajaxify.data.topics });\n\t};\n\n\tRecent.watchForNewPosts = function () {\n\t\tnewPostCount = 0;\n\t\tnewTopicCount = 0;\n\t\tRecent.removeListeners();\n\t\tsocket.on('event:new_topic', onNewTopic);\n\t\tsocket.on('event:new_post', onNewPost);\n\t};\n\n\tfunction onNewTopic(data) {\n\t\tif (ajaxify.data.selectedCids && ajaxify.data.selectedCids.indexOf(parseInt(data.cid, 10)) === -1) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (ajaxify.data.selectedFilter && ajaxify.data.selectedFilter.filter === 'watched') {\n\t\t\treturn;\n\t\t}\n\n\t\tif (ajaxify.data.template.category && parseInt(ajaxify.data.cid, 10) !== parseInt(data.cid, 10)) {\n\t\t\treturn;\n\t\t}\n\n\t\tnewTopicCount += 1;\n\t\tRecent.updateAlertText();\n\t}\n\n\tfunction onNewPost(data) {\n\t\tfunction showAlert() {\n\t\t\tnewPostCount += 1;\n\t\t\tRecent.updateAlertText();\n\t\t}\n\n\t\tvar post = data.posts[0];\n\t\tif (!post || !post.topic) {\n\t\t\treturn;\n\t\t}\n\t\tif (parseInt(post.topic.mainPid, 10) === parseInt(post.pid, 10)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (ajaxify.data.selectedCids && ajaxify.data.selectedCids.indexOf(parseInt(post.topic.cid, 10)) === -1) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (ajaxify.data.selectedFilter && ajaxify.data.selectedFilter.filter === 'new') {\n\t\t\treturn;\n\t\t}\n\n\t\tif (ajaxify.data.template.category && parseInt(ajaxify.data.cid, 10) !== parseInt(post.topic.cid, 10)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (ajaxify.data.selectedFilter && ajaxify.data.selectedFilter.filter === 'watched') {\n\t\t\tsocket.emit('topics.isFollowed', post.tid, function (err, isFollowed) {\n\t\t\t\tif (err) {\n\t\t\t\t\tapp.alertError(err.message);\n\t\t\t\t}\n\t\t\t\tif (isFollowed) {\n\t\t\t\t\tshowAlert();\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\n\t\tshowAlert();\n\t}\n\n\tRecent.handleCategorySelection = function () {\n\t\tfunction getSelectedCids() {\n\t\t\tvar cids = [];\n\t\t\t$('[component=\"category/list\"] [data-cid]').each(function (index, el) {\n\t\t\t\tif ($(el).find('i.fa-check').length) {\n\t\t\t\t\tcids.push(parseInt($(el).attr('data-cid'), 10));\n\t\t\t\t}\n\t\t\t});\n\t\t\tcids.sort(function (a, b) {\n\t\t\t\treturn a - b;\n\t\t\t});\n\t\t\treturn cids;\n\t\t}\n\n\t\t$('[component=\"category/dropdown\"]').on('hidden.bs.dropdown', function () {\n\t\t\tvar cids = getSelectedCids();\n\t\t\tvar changed = ajaxify.data.selectedCids.length !== cids.length;\n\t\t\tajaxify.data.selectedCids.forEach(function (cid, index) {\n\t\t\t\tif (cid !== cids[index]) {\n\t\t\t\t\tchanged = true;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (changed) {\n\t\t\t\tvar url = window.location.pathname;\n\t\t\t\tvar currentParams = utils.params();\n\t\t\t\tif (cids.length) {\n\t\t\t\t\tcurrentParams.cid = cids;\n\t\t\t\t\turl += '?' + decodeURIComponent($.param(currentParams));\n\t\t\t\t}\n\t\t\t\tajaxify.go(url);\n\t\t\t}\n\t\t});\n\n\t\t$('[component=\"category/list\"]').on('click', '[data-cid]', function (ev) {\n\t\t\tfunction selectChildren(parentCid, flag) {\n\t\t\t\t$('[component=\"category/list\"] [data-parent-cid=\"' + parentCid + '\"] [component=\"category/select/icon\"]').toggleClass('fa-check', flag);\n\t\t\t\t$('[component=\"category/list\"] [data-parent-cid=\"' + parentCid + '\"]').each(function (index, el) {\n\t\t\t\t\tselectChildren($(el).attr('data-cid'), flag);\n\t\t\t\t});\n\t\t\t}\n\t\t\tvar categoryEl = $(this);\n\t\t\tvar cid = $(this).attr('data-cid');\n\t\t\tif (ev.ctrlKey) {\n\t\t\t\tselectChildren(cid, !categoryEl.find('[component=\"category/select/icon\"]').hasClass('fa-check'));\n\t\t\t}\n\t\t\tcategoryEl.find('[component=\"category/select/icon\"]').toggleClass('fa-check');\n\t\t\t$('[component=\"category/list\"] li').first().find('i').toggleClass('fa-check', !getSelectedCids().length);\n\t\t\treturn false;\n\t\t});\n\t};\n\n\tRecent.removeListeners = function () {\n\t\tsocket.removeListener('event:new_topic', onNewTopic);\n\t\tsocket.removeListener('event:new_post', onNewPost);\n\t};\n\n\tRecent.updateAlertText = function () {\n\t\tvar text = '';\n\n\t\tif (newTopicCount === 0) {\n\t\t\tif (newPostCount === 1) {\n\t\t\t\ttext = '[[recent:there-is-a-new-post]]';\n\t\t\t} else if (newPostCount > 1) {\n\t\t\t\ttext = '[[recent:there-are-new-posts, ' + newPostCount + ']]';\n\t\t\t}\n\t\t} else if (newTopicCount === 1) {\n\t\t\tif (newPostCount === 0) {\n\t\t\t\ttext = '[[recent:there-is-a-new-topic]]';\n\t\t\t} else if (newPostCount === 1) {\n\t\t\t\ttext = '[[recent:there-is-a-new-topic-and-a-new-post]]';\n\t\t\t} else if (newPostCount > 1) {\n\t\t\t\ttext = '[[recent:there-is-a-new-topic-and-new-posts, ' + newPostCount + ']]';\n\t\t\t}\n\t\t} else if (newTopicCount > 1) {\n\t\t\tif (newPostCount === 0) {\n\t\t\t\ttext = '[[recent:there-are-new-topics, ' + newTopicCount + ']]';\n\t\t\t} else if (newPostCount === 1) {\n\t\t\t\ttext = '[[recent:there-are-new-topics-and-a-new-post, ' + newTopicCount + ']]';\n\t\t\t} else if (newPostCount > 1) {\n\t\t\t\ttext = '[[recent:there-are-new-topics-and-new-posts, ' + newTopicCount + ', ' + newPostCount + ']]';\n\t\t\t}\n\t\t}\n\n\t\ttext += ' [[recent:click-here-to-reload]]';\n\n\t\t$('#new-topics-alert').translateText(text).removeClass('hide').fadeIn('slow');\n\t\t$('#category-no-topics').addClass('hide');\n\t};\n\n\tRecent.loadMoreTopics = function (direction) {\n\t\tif (!$('[component=\"category\"]').length) {\n\t\t\treturn;\n\t\t}\n\t\tvar topics = $('[component=\"category/topic\"]');\n\t\tvar afterEl = direction > 0 ? topics.last() : topics.first();\n\t\tvar after = (parseInt(afterEl.attr('data-index'), 10) || 0) + (direction > 0 ? 1 : 0);\n\t\tloadTopicsAfter(after, direction);\n\t};\n\n\tfunction loadTopicsAfter(after, direction, callback) {\n\t\tcallback = callback || function () {};\n\t\tinfinitescroll.loadMore('topics.loadMoreRecentTopics', {\n\t\t\tafter: after,\n\t\t\tdirection: direction,\n\t\t\tcount: config.topicsPerPage,\n\t\t\tcid: utils.params().cid,\n\t\t\tfilter: ajaxify.data.selectedFilter.filter,\n\t\t\tset: $('[component=\"category\"]').attr('data-set') ? $('[component=\"category\"]').attr('data-set') : 'topics:recent',\n\t\t}, function (data, done) {\n\t\t\tif (data.topics && data.topics.length) {\n\t\t\t\tRecent.onTopicsLoaded('recent', data.topics, false, direction, done);\n\t\t\t} else {\n\t\t\t\tdone();\n\t\t\t}\n\t\t\t$('[component=\"category\"]').attr('data-nextstart', data.nextStart);\n\t\t\tcallback();\n\t\t});\n\t}\n\n\tRecent.onTopicsLoaded = function (templateName, topics, showSelect, direction, callback) {\n\t\ttopics = topics.filter(function (topic) {\n\t\t\treturn !components.get('category/topic', 'tid', topic.tid).length;\n\t\t});\n\n\t\tif (!topics.length) {\n\t\t\treturn callback();\n\t\t}\n\n\t\tvar after;\n\t\tvar before;\n\t\tvar topicsList = $('[component=\"category/topic\"]');\n\n\t\tif (direction > 0 && topics.length) {\n\t\t\tafter = topicsList.last();\n\t\t} else if (direction < 0 && topics.length) {\n\t\t\tbefore = topicsList.first();\n\t\t}\n\n\t\tapp.parseAndTranslate(templateName, 'topics', { topics: topics, showSelect: showSelect }, function (html) {\n\t\t\t$('#category-no-topics').remove();\n\n\t\t\tif (after && after.length) {\n\t\t\t\thtml.insertAfter(after);\n\t\t\t} else if (before && before.length) {\n\t\t\t\tvar height = $(document).height();\n\t\t\t\tvar scrollTop = $(window).scrollTop();\n\n\t\t\t\thtml.insertBefore(before);\n\n\t\t\t\t$(window).scrollTop(scrollTop + ($(document).height() - height));\n\t\t\t} else {\n\t\t\t\t$('[component=\"category\"]').append(html);\n\t\t\t}\n\n\t\t\thtml.find('.timeago').timeago();\n\t\t\tapp.createUserTooltips();\n\t\t\tutils.makeNumbersHumanReadable(html.find('.human-readable-number'));\n\t\t\t$(window).trigger('action:topics.loaded', { topics: topics });\n\t\t\tcallback();\n\t\t});\n\t};\n\n\treturn Recent;\n});\n"]}