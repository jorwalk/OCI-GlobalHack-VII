{"version":3,"sources":["public/src/client/unread.js"],"names":["define","recent","topicSelect","infinitescroll","components","Unread","$","window","on","ev","data","ajaxify","currentPage","url","removeListeners","init","app","enterRoom","this","addClass","watchForNewPosts","handleCategorySelection","trigger","topics","tids","getSelectedTids","length","socket","emit","err","alertError","message","doneRemovingTids","alertSuccess","empty","removeClass","getCategoryTids","cid","get","each","push","attr","height","children","show","loadMoreTopics","config","usePagination","direction","loadMore","after","count","topicsPerPage","utils","params","filter","selectedFilter","done","onTopicsLoaded","nextStart","hide","removeTids","i","remove"],"mappings":"AAAA,aAGAA,OAAO,gBAAiB,eAAgB,cAAe,uBAAwB,cAAe,SAAUC,EAAQC,EAAaC,EAAgBC,GAC5I,IAAIC,KAEJC,EAAEC,QAAQC,GAAG,uBAAwB,SAAUC,EAAIC,GAClD,GAAIC,QAAQC,cAAgBF,EAAKG,IAAK,CACrCZ,EAAOa,qBAITT,EAAOU,KAAO,WACbC,IAAIC,UAAU,iBAEdX,EAAE,qBAAqBE,GAAG,QAAS,WAClCF,EAAEY,MAAMC,SAAS,UAGlBlB,EAAOmB,mBAEPnB,EAAOoB,0BAEPf,EAAEC,QAAQe,QAAQ,wBAA0BC,OAAQZ,QAAQD,KAAKa,SAEjEjB,EAAE,qBAAqBE,GAAG,QAAS,WAClC,IAAIgB,EAAOtB,EAAYuB,kBACvB,IAAKD,EAAKE,OAAQ,CACjB,OAEDC,OAAOC,KAAK,oBAAqBJ,EAAM,SAAUK,GAChD,GAAIA,EAAK,CACR,OAAOb,IAAIc,WAAWD,EAAIE,SAG3BC,EAAiBR,OAInBlB,EAAE,gBAAgBE,GAAG,QAAS,WAC7BmB,OAAOC,KAAK,qBAAsB,SAAUC,GAC3C,GAAIA,EAAK,CACR,OAAOb,IAAIc,WAAWD,EAAIE,SAG3Bf,IAAIiB,aAAa,4CAEjB3B,EAAE,0BAA0B4B,QAC5B5B,EAAE,4BAA4Ba,SAAS,UACvCb,EAAE,uBAAuB6B,YAAY,UACrC7B,EAAE,aAAaa,SAAS,cAI1Bb,EAAE,aAAaE,GAAG,QAAS,YAAa,WACvC,SAAS4B,EAAgBC,GACxB,IAAIb,KACJpB,EAAWkC,IAAI,iBAAkB,MAAOD,GAAKE,KAAK,WACjDf,EAAKgB,KAAKlC,EAAEY,MAAMuB,KAAK,eAExB,OAAOjB,EAER,IAAIa,EAAM/B,EAAEY,MAAMuB,KAAK,YACvB,IAAIjB,EAAOY,EAAgBC,GAE3BV,OAAOC,KAAK,gCAAiCS,EAAK,SAAUR,GAC3D,GAAIA,EAAK,CACR,OAAOb,IAAIc,WAAWD,EAAIE,SAG3BC,EAAiBR,OAInBtB,EAAYa,OAEZ,GAAIT,EAAE,QAAQoC,UAAYpC,EAAEC,QAAQmC,UAAYpC,EAAE,0BAA0BqC,WAAWjB,QAAU,GAAI,CACpGpB,EAAE,kBAAkBsC,OAGrBtC,EAAE,kBAAkBE,GAAG,QAAS,WAC/BqC,MAGD,IAAKC,OAAOC,cAAe,CAC1B5C,EAAeY,KAAK8B,GAGrB,SAASA,EAAeG,GACvB,GAAIA,EAAY,IAAM1C,EAAE,0BAA0BoB,OAAQ,CACzD,OAGDvB,EAAe8C,SAAS,+BACvBC,MAAO5C,EAAE,0BAA0BmC,KAAK,kBACxCU,MAAOL,OAAOM,cACdf,IAAKgB,MAAMC,SAASjB,IACpBkB,OAAQ5C,QAAQD,KAAK8C,eAAeD,QAClC,SAAU7C,EAAM+C,GAClB,GAAI/C,EAAKa,QAAUb,EAAKa,OAAOG,OAAQ,CACtCzB,EAAOyD,eAAe,SAAUhD,EAAKa,OAAQ,KAAMyB,EAAWS,GAC9DnD,EAAE,0BAA0BmC,KAAK,iBAAkB/B,EAAKiD,eAClD,CACNF,IACAnD,EAAE,kBAAkBsD,YAMxB,SAAS5B,EAAiBR,GACzBqC,EAAWrC,GAEXR,IAAIiB,aAAa,4CAEjB,IAAK3B,EAAE,0BAA0BqC,WAAWjB,OAAQ,CACnDpB,EAAE,uBAAuB6B,YAAY,UACrC7B,EAAE,aAAaa,SAAS,WAI1B,SAAS0C,EAAWrC,GACnB,IAAK,IAAIsC,EAAI,EAAGA,EAAItC,EAAKE,OAAQoC,GAAK,EAAG,CACxC1D,EAAWkC,IAAI,iBAAkB,MAAOd,EAAKsC,IAAIC,UAKnD,OAAO1D","file":"public/src/client/unread.js","sourcesContent":["'use strict';\n\n\ndefine('forum/unread', ['forum/recent', 'topicSelect', 'forum/infinitescroll', 'components'], function (recent, topicSelect, infinitescroll, components) {\n\tvar Unread = {};\n\n\t$(window).on('action:ajaxify.start', function (ev, data) {\n\t\tif (ajaxify.currentPage !== data.url) {\n\t\t\trecent.removeListeners();\n\t\t}\n\t});\n\n\tUnread.init = function () {\n\t\tapp.enterRoom('unread_topics');\n\n\t\t$('#new-topics-alert').on('click', function () {\n\t\t\t$(this).addClass('hide');\n\t\t});\n\n\t\trecent.watchForNewPosts();\n\n\t\trecent.handleCategorySelection();\n\n\t\t$(window).trigger('action:topics.loaded', { topics: ajaxify.data.topics });\n\n\t\t$('#markSelectedRead').on('click', function () {\n\t\t\tvar tids = topicSelect.getSelectedTids();\n\t\t\tif (!tids.length) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tsocket.emit('topics.markAsRead', tids, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\tdoneRemovingTids(tids);\n\t\t\t});\n\t\t});\n\n\t\t$('#markAllRead').on('click', function () {\n\t\t\tsocket.emit('topics.markAllRead', function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\tapp.alertSuccess('[[unread:topics_marked_as_read.success]]');\n\n\t\t\t\t$('[component=\"category\"]').empty();\n\t\t\t\t$('[component=\"pagination\"]').addClass('hidden');\n\t\t\t\t$('#category-no-topics').removeClass('hidden');\n\t\t\t\t$('.markread').addClass('hidden');\n\t\t\t});\n\t\t});\n\n\t\t$('.markread').on('click', '.category', function () {\n\t\t\tfunction getCategoryTids(cid) {\n\t\t\t\tvar tids = [];\n\t\t\t\tcomponents.get('category/topic', 'cid', cid).each(function () {\n\t\t\t\t\ttids.push($(this).attr('data-tid'));\n\t\t\t\t});\n\t\t\t\treturn tids;\n\t\t\t}\n\t\t\tvar cid = $(this).attr('data-cid');\n\t\t\tvar tids = getCategoryTids(cid);\n\n\t\t\tsocket.emit('topics.markCategoryTopicsRead', cid, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\tdoneRemovingTids(tids);\n\t\t\t});\n\t\t});\n\n\t\ttopicSelect.init();\n\n\t\tif ($('body').height() <= $(window).height() && $('[component=\"category\"]').children().length >= 20) {\n\t\t\t$('#load-more-btn').show();\n\t\t}\n\n\t\t$('#load-more-btn').on('click', function () {\n\t\t\tloadMoreTopics();\n\t\t});\n\n\t\tif (!config.usePagination) {\n\t\t\tinfinitescroll.init(loadMoreTopics);\n\t\t}\n\n\t\tfunction loadMoreTopics(direction) {\n\t\t\tif (direction < 0 || !$('[component=\"category\"]').length) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tinfinitescroll.loadMore('topics.loadMoreUnreadTopics', {\n\t\t\t\tafter: $('[component=\"category\"]').attr('data-nextstart'),\n\t\t\t\tcount: config.topicsPerPage,\n\t\t\t\tcid: utils.params().cid,\n\t\t\t\tfilter: ajaxify.data.selectedFilter.filter,\n\t\t\t}, function (data, done) {\n\t\t\t\tif (data.topics && data.topics.length) {\n\t\t\t\t\trecent.onTopicsLoaded('unread', data.topics, true, direction, done);\n\t\t\t\t\t$('[component=\"category\"]').attr('data-nextstart', data.nextStart);\n\t\t\t\t} else {\n\t\t\t\t\tdone();\n\t\t\t\t\t$('#load-more-btn').hide();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n\n\tfunction doneRemovingTids(tids) {\n\t\tremoveTids(tids);\n\n\t\tapp.alertSuccess('[[unread:topics_marked_as_read.success]]');\n\n\t\tif (!$('[component=\"category\"]').children().length) {\n\t\t\t$('#category-no-topics').removeClass('hidden');\n\t\t\t$('.markread').addClass('hidden');\n\t\t}\n\t}\n\n\tfunction removeTids(tids) {\n\t\tfor (var i = 0; i < tids.length; i += 1) {\n\t\t\tcomponents.get('category/topic', 'tid', tids[i]).remove();\n\t\t}\n\t}\n\n\n\treturn Unread;\n});\n"]}