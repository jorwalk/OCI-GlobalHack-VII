{"version":3,"sources":["public/src/client/chats.js"],"names":["define","components","translator","mousetrap","recentChats","search","messages","Benchpress","Chats","initialised","newMessage","init","env","utils","findBootstrapEnvironment","addSocketListeners","addGlobalEventListeners","addEventListeners","createAutoComplete","$","resizeMainWindow","addHotkeys","document","ready","window","trigger","scrollToBottom","ajaxify","data","hasOwnProperty","get","focus","addSendHandlers","roomId","addPopoutHandler","addActionHandlers","addMemberHandler","find","addRenameHandler","addLeaveHandler","addScrollHandler","uid","addCharactersLeftHandler","addIPHandler","container","on","ipEl","this","parent","mid","parents","attr","socket","emit","err","ip","app","alertError","html","text","val","previousUrl","match","go","userslug","openChat","history","one","el","loading","off","top","scrollHeight","height","scrollTop","start","parseInt","children","length","message","parseMessage","currentScrollTop","previousHeight","prepend","timeago","addClass","element","updateRemainingLength","messageId","action","getAttribute","inputEl","prepEdit","delete","restore","bind","activeContact","prev","switchChat","next","e","target","last","lastMid","buttonEl","modal","parse","translate","bootbox","dialog","title","refreshParticipantsList","addKickHandler","searchInput","errorEl","require","autocomplete","user","event","selected","username","item","name","translated","confirm","size","callback","ok","chatLib","close","users","listEl","parseAndTranslate","roomName","buttons","save","label","className","submit","newName","sendEl","which","shiftKey","sendMessage","strategies","options","zIndex","listPosition","position","$el","css","_applyPlacement","textcomplete","leave","remove","chat","getModal","roomid","url","self","fetch","config","relative_path","credentials","then","response","json","payload","setActive","pushState","location","protocol","host","console","warn","status","catch","error","appendChatMessage","template","chats","roomEl","recentEl","rooms","lastUser","fromUser","usernames","unread","updateUserStatus","onChatMessageEdit","titleEl","viewportHeight","fromTop","offset","toggleClass","removeClass"],"mappings":"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","file":"public/src/client/chats.js","sourcesContent":["'use strict';\n\n\ndefine('forum/chats', [\n\t'components',\n\t'translator',\n\t'mousetrap',\n\t'forum/chats/recent',\n\t'forum/chats/search',\n\t'forum/chats/messages',\n\t'benchpress',\n], function (components, translator, mousetrap, recentChats, search, messages, Benchpress) {\n\tvar Chats = {\n\t\tinitialised: false,\n\t};\n\n\tvar newMessage = false;\n\n\tChats.init = function () {\n\t\tvar env = utils.findBootstrapEnvironment();\n\n\t\tif (!Chats.initialised) {\n\t\t\tChats.addSocketListeners();\n\t\t\tChats.addGlobalEventListeners();\n\t\t}\n\n\t\trecentChats.init();\n\n\t\tChats.addEventListeners();\n\t\tChats.createAutoComplete($('[component=\"chat/input\"]'));\n\t\tChats.resizeMainWindow();\n\n\t\tif (env === 'md' || env === 'lg') {\n\t\t\tChats.addHotkeys();\n\t\t}\n\n\t\t$(document).ready(function () {\n\t\t\t$(window).trigger('action:chat.loaded', $('.chats-full'));\n\t\t});\n\n\t\tChats.initialised = true;\n\t\tmessages.scrollToBottom($('.expanded-chat ul.chat-content'));\n\n\t\tsearch.init();\n\n\t\tif (ajaxify.data.hasOwnProperty('roomId')) {\n\t\t\tcomponents.get('chat/input').focus();\n\t\t}\n\t};\n\n\tChats.addEventListeners = function () {\n\t\tChats.addSendHandlers(ajaxify.data.roomId, $('.chat-input'), $('.expanded-chat button[data-action=\"send\"]'));\n\t\tChats.addPopoutHandler();\n\t\tChats.addActionHandlers(components.get('chat/messages'), ajaxify.data.roomId);\n\t\tChats.addMemberHandler(ajaxify.data.roomId, components.get('chat/controls').find('[data-action=\"members\"]'));\n\t\tChats.addRenameHandler(ajaxify.data.roomId, components.get('chat/controls').find('[data-action=\"rename\"]'));\n\t\tChats.addLeaveHandler(ajaxify.data.roomId, components.get('chat/controls').find('[data-action=\"leave\"]'));\n\t\tChats.addScrollHandler(ajaxify.data.roomId, ajaxify.data.uid, $('.chat-content'));\n\t\tChats.addCharactersLeftHandler($('[component=\"chat/main-wrapper\"]'));\n\t\tChats.addIPHandler($('[component=\"chat/main-wrapper\"]'));\n\t};\n\n\tChats.addIPHandler = function (container) {\n\t\tcontainer.on('click', '.chat-ip-button', function () {\n\t\t\tvar ipEl = $(this).parent();\n\t\t\tvar mid = ipEl.parents('[data-mid]').attr('data-mid');\n\t\t\tsocket.emit('modules.chats.getIP', mid, function (err, ip) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err);\n\t\t\t\t}\n\t\t\t\tipEl.html(ip);\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addPopoutHandler = function () {\n\t\t$('[data-action=\"pop-out\"]').on('click', function () {\n\t\t\tvar text = components.get('chat/input').val();\n\t\t\tvar roomId = ajaxify.data.roomId;\n\n\t\t\tif (app.previousUrl && app.previousUrl.match(/chats/)) {\n\t\t\t\tajaxify.go('user/' + ajaxify.data.userslug + '/chats', function () {\n\t\t\t\t\tapp.openChat(roomId, ajaxify.data.uid);\n\t\t\t\t}, true);\n\t\t\t} else {\n\t\t\t\twindow.history.go(-1);\n\t\t\t\tapp.openChat(roomId, ajaxify.data.uid);\n\t\t\t}\n\n\t\t\t$(window).one('action:chat.loaded', function () {\n\t\t\t\tcomponents.get('chat/input').val(text);\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addScrollHandler = function (roomId, uid, el) {\n\t\tvar loading = false;\n\t\tel.off('scroll').on('scroll', function () {\n\t\t\tif (loading) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar top = (el[0].scrollHeight - el.height()) * 0.1;\n\t\t\tif (el.scrollTop() >= top) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tloading = true;\n\t\t\tvar start = parseInt(el.children('[data-mid]').length, 10);\n\t\t\tsocket.emit('modules.chats.getMessages', {\n\t\t\t\troomId: roomId,\n\t\t\t\tuid: uid,\n\t\t\t\tstart: start,\n\t\t\t}, function (err, data) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\tif (!data) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tmessages.parseMessage(data, function (html) {\n\t\t\t\t\tvar currentScrollTop = el.scrollTop();\n\t\t\t\t\tvar previousHeight = el[0].scrollHeight;\n\t\t\t\t\thtml = $(html);\n\t\t\t\t\tel.prepend(html);\n\t\t\t\t\thtml.find('.timeago').timeago();\n\t\t\t\t\thtml.find('img:not(.not-responsive)').addClass('img-responsive');\n\t\t\t\t\tel.scrollTop((el[0].scrollHeight - previousHeight) + currentScrollTop);\n\t\t\t\t\tloading = false;\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addCharactersLeftHandler = function (parent) {\n\t\tvar element = parent.find('[component=\"chat/input\"]');\n\t\telement.on('change keyup paste', function () {\n\t\t\tmessages.updateRemainingLength(parent);\n\t\t});\n\t};\n\n\tChats.addActionHandlers = function (element, roomId) {\n\t\telement.on('click', '[data-action]', function () {\n\t\t\tvar messageId = $(this).parents('[data-mid]').attr('data-mid');\n\t\t\tvar action = this.getAttribute('data-action');\n\n\t\t\tswitch (action) {\n\t\t\tcase 'edit':\n\t\t\t\tvar inputEl = $('[data-roomid=\"' + roomId + '\"] [component=\"chat/input\"]');\n\t\t\t\tmessages.prepEdit(inputEl, messageId, roomId);\n\t\t\t\tbreak;\n\n\t\t\tcase 'delete':\n\t\t\t\tmessages.delete(messageId, roomId);\n\t\t\t\tbreak;\n\n\t\t\tcase 'restore':\n\t\t\t\tmessages.restore(messageId, roomId);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t});\n\t};\n\n\tChats.addHotkeys = function () {\n\t\tmousetrap.bind('ctrl+up', function () {\n\t\t\tvar activeContact = $('.chats-list .bg-info');\n\t\t\tvar prev = activeContact.prev();\n\n\t\t\tif (prev.length) {\n\t\t\t\tChats.switchChat(prev.attr('data-roomid'));\n\t\t\t}\n\t\t});\n\t\tmousetrap.bind('ctrl+down', function () {\n\t\t\tvar activeContact = $('.chats-list .bg-info');\n\t\t\tvar next = activeContact.next();\n\n\t\t\tif (next.length) {\n\t\t\t\tChats.switchChat(next.attr('data-roomid'));\n\t\t\t}\n\t\t});\n\t\tmousetrap.bind('up', function (e) {\n\t\t\tif (e.target === components.get('chat/input').get(0)) {\n\t\t\t\t// Retrieve message id from messages list\n\t\t\t\tvar message = components.get('chat/messages').find('.chat-message[data-self=\"1\"]').last();\n\t\t\t\tvar lastMid = message.attr('data-mid');\n\t\t\t\tvar inputEl = components.get('chat/input');\n\n\t\t\t\tmessages.prepEdit(inputEl, lastMid, ajaxify.data.roomId);\n\t\t\t}\n\t\t});\n\t};\n\n\tChats.addMemberHandler = function (roomId, buttonEl) {\n\t\tvar modal;\n\n\t\tbuttonEl.on('click', function () {\n\t\t\tBenchpress.parse('partials/modals/manage_room', {}, function (html) {\n\t\t\t\ttranslator.translate(html, function (html) {\n\t\t\t\t\tmodal = bootbox.dialog({\n\t\t\t\t\t\ttitle: '[[modules:chat.manage-room]]',\n\t\t\t\t\t\tmessage: html,\n\t\t\t\t\t});\n\n\t\t\t\t\tmodal.attr('component', 'chat/manage-modal');\n\n\t\t\t\t\tChats.refreshParticipantsList(roomId, modal);\n\t\t\t\t\tChats.addKickHandler(roomId, modal);\n\n\t\t\t\t\tvar searchInput = modal.find('input');\n\t\t\t\t\tvar errorEl = modal.find('.text-danger');\n\t\t\t\t\trequire(['autocomplete', 'translator'], function (autocomplete, translator) {\n\t\t\t\t\t\tautocomplete.user(searchInput, function (event, selected) {\n\t\t\t\t\t\t\terrorEl.text('');\n\t\t\t\t\t\t\tsocket.emit('modules.chats.addUserToRoom', {\n\t\t\t\t\t\t\t\troomId: roomId,\n\t\t\t\t\t\t\t\tusername: selected.item.user.name,\n\t\t\t\t\t\t\t}, function (err) {\n\t\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\t\ttranslator.translate(err.message, function (translated) {\n\t\t\t\t\t\t\t\t\t\terrorEl.text(translated);\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tChats.refreshParticipantsList(roomId, modal);\n\t\t\t\t\t\t\t\tsearchInput.val('');\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addKickHandler = function (roomId, modal) {\n\t\tmodal.on('click', '[data-action=\"kick\"]', function () {\n\t\t\tvar uid = parseInt(this.getAttribute('data-uid'), 10);\n\n\t\t\tsocket.emit('modules.chats.removeUserFromRoom', {\n\t\t\t\troomId: roomId,\n\t\t\t\tuid: uid,\n\t\t\t}, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\tChats.refreshParticipantsList(roomId, modal);\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addLeaveHandler = function (roomId, buttonEl) {\n\t\tbuttonEl.on('click', function () {\n\t\t\tbootbox.confirm({\n\t\t\t\tsize: 'small',\n\t\t\t\ttitle: '[[modules:chat.leave]]',\n\t\t\t\tmessage: '<p>[[modules:chat.leave-prompt]]</p><p class=\"help-block\">[[modules:chat.leave-help]]</p>',\n\t\t\t\tcallback: function (ok) {\n\t\t\t\t\tif (ok) {\n\t\t\t\t\t\tsocket.emit('modules.chats.leave', roomId, function (err) {\n\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\tapp.alertError(err.message);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// Return user to chats page. If modal, close modal.\n\t\t\t\t\t\t\tvar modal = buttonEl.parents('.chat-modal');\n\t\t\t\t\t\t\tif (modal.length) {\n\t\t\t\t\t\t\t\trequire(['chat'], function (chatLib) {\n\t\t\t\t\t\t\t\t\tchatLib.close(modal);\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tajaxify.go('chats');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.refreshParticipantsList = function (roomId, modal) {\n\t\tsocket.emit('modules.chats.getUsersInRoom', { roomId: roomId }, function (err, users) {\n\t\t\tvar listEl = modal.find('.list-group');\n\n\t\t\tif (err) {\n\t\t\t\treturn translator.translate('[[error:invalid-data]]', function (translated) {\n\t\t\t\t\tlistEl.find('li').text(translated);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tapp.parseAndTranslate('partials/modals/manage_room_users', {\n\t\t\t\tusers: users,\n\t\t\t}, function (html) {\n\t\t\t\tlistEl.html(html);\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addRenameHandler = function (roomId, buttonEl, roomName) {\n\t\tvar modal;\n\n\t\tbuttonEl.on('click', function () {\n\t\t\tBenchpress.parse('partials/modals/rename_room', {\n\t\t\t\tname: roomName || ajaxify.data.roomName,\n\t\t\t}, function (html) {\n\t\t\t\ttranslator.translate(html, function (html) {\n\t\t\t\t\tmodal = bootbox.dialog({\n\t\t\t\t\t\ttitle: '[[modules:chat.rename-room]]',\n\t\t\t\t\t\tmessage: html,\n\t\t\t\t\t\tbuttons: {\n\t\t\t\t\t\t\tsave: {\n\t\t\t\t\t\t\t\tlabel: '[[global:save]]',\n\t\t\t\t\t\t\t\tclassName: 'btn-primary',\n\t\t\t\t\t\t\t\tcallback: submit,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\tfunction submit() {\n\t\t\tsocket.emit('modules.chats.renameRoom', {\n\t\t\t\troomId: roomId,\n\t\t\t\tnewName: modal.find('#roomName').val(),\n\t\t\t}, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n\n\tChats.addSendHandlers = function (roomId, inputEl, sendEl) {\n\t\tinputEl.off('keypress').on('keypress', function (e) {\n\t\t\tif (e.which === 13 && !e.shiftKey) {\n\t\t\t\tmessages.sendMessage(roomId, inputEl);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t});\n\n\t\tsendEl.off('click').on('click', function () {\n\t\t\tmessages.sendMessage(roomId, inputEl);\n\t\t\tinputEl.focus();\n\t\t\treturn false;\n\t\t});\n\t};\n\n\tChats.createAutoComplete = function (element) {\n\t\tvar data = {\n\t\t\telement: element,\n\t\t\tstrategies: [],\n\t\t\toptions: {\n\t\t\t\tzIndex: 20000,\n\t\t\t\tlistPosition: function (position) {\n\t\t\t\t\tthis.$el.css(this._applyPlacement(position));\n\t\t\t\t\tthis.$el.css('position', 'absolute');\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t},\n\t\t};\n\n\t\t$(window).trigger('chat:autocomplete:init', data);\n\t\tif (data.strategies.length) {\n\t\t\tdata.element.textcomplete(data.strategies, data.options);\n\t\t}\n\t};\n\n\tChats.leave = function (el) {\n\t\tvar roomId = el.attr('data-roomid');\n\t\tsocket.emit('modules.chats.leave', roomId, function (err) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\t\t\tif (parseInt(roomId, 10) === parseInt(ajaxify.data.roomId, 10)) {\n\t\t\t\tajaxify.go('user/' + ajaxify.data.userslug + '/chats');\n\t\t\t} else {\n\t\t\t\tel.remove();\n\t\t\t}\n\t\t\trequire(['chat'], function (chat) {\n\t\t\t\tvar modal = chat.getModal(roomId);\n\t\t\t\tif (modal.length) {\n\t\t\t\t\tchat.close(modal);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.switchChat = function (roomid) {\n\t\tvar url = 'user/' + ajaxify.data.userslug + '/chats/' + roomid;\n\t\tif (self.fetch) {\n\t\t\tfetch(config.relative_path + '/api/' + url, { credentials: 'include' })\n\t\t\t\t.then(function (response) {\n\t\t\t\t\tif (response.ok) {\n\t\t\t\t\t\tresponse.json().then(function (payload) {\n\t\t\t\t\t\t\tapp.parseAndTranslate('partials/chats/message-window', payload, function (html) {\n\t\t\t\t\t\t\t\tcomponents.get('chat/main-wrapper').html(html);\n\t\t\t\t\t\t\t\thtml.find('.timeago').timeago();\n\t\t\t\t\t\t\t\tChats.resizeMainWindow();\n\t\t\t\t\t\t\t\tajaxify.data = payload;\n\t\t\t\t\t\t\t\tChats.setActive();\n\t\t\t\t\t\t\t\tChats.addEventListeners();\n\t\t\t\t\t\t\t\t$(window).trigger('action:chat.loaded', $('.chats-full'));\n\t\t\t\t\t\t\t\tmessages.scrollToBottom($('.expanded-chat ul.chat-content'));\n\t\t\t\t\t\t\t\tif (history.pushState) {\n\t\t\t\t\t\t\t\t\thistory.pushState({\n\t\t\t\t\t\t\t\t\t\turl: 'user/' + payload.userslug + '/chats/' + payload.roomId,\n\t\t\t\t\t\t\t\t\t}, null, window.location.protocol + '//' + window.location.host + config.relative_path + '/user/' + payload.userslug + '/chats/' + payload.roomId);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.warn('[search] Received ' + response.status);\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.catch(function (error) {\n\t\t\t\t\tconsole.warn('[search] ' + error.message);\n\t\t\t\t});\n\t\t} else {\n\t\t\tajaxify.go(url);\n\t\t}\n\t};\n\n\tChats.addGlobalEventListeners = function () {\n\t\t$(window).on('resize', Chats.resizeMainWindow);\n\t\t$(window).on('mousemove keypress click', function () {\n\t\t\tif (newMessage && ajaxify.data.roomId) {\n\t\t\t\tsocket.emit('modules.chats.markRead', ajaxify.data.roomId);\n\t\t\t\tnewMessage = false;\n\t\t\t}\n\t\t});\n\t};\n\n\tChats.addSocketListeners = function () {\n\t\tsocket.on('event:chats.receive', function (data) {\n\t\t\tif (parseInt(data.roomId, 10) === parseInt(ajaxify.data.roomId, 10)) {\n\t\t\t\tnewMessage = data.self === 0;\n\t\t\t\tdata.message.self = data.self;\n\n\t\t\t\tmessages.appendChatMessage($('.expanded-chat .chat-content'), data.message);\n\t\t\t} else if (ajaxify.data.template.chats) {\n\t\t\t\tvar roomEl = $('[data-roomid=' + data.roomId + ']');\n\n\t\t\t\tif (roomEl.length > 0) {\n\t\t\t\t\troomEl.addClass('unread');\n\t\t\t\t} else {\n\t\t\t\t\tvar recentEl = components.get('chat/recent');\n\t\t\t\t\tBenchpress.parse('partials/chats/recent_room', {\n\t\t\t\t\t\trooms: {\n\t\t\t\t\t\t\troomId: data.roomId,\n\t\t\t\t\t\t\tlastUser: data.message.fromUser,\n\t\t\t\t\t\t\tusernames: data.message.fromUser.username,\n\t\t\t\t\t\t\tunread: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t}, function (html) {\n\t\t\t\t\t\ttranslator.translate(html, function (translated) {\n\t\t\t\t\t\t\trecentEl.prepend(translated);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tsocket.on('event:user_status_change', function (data) {\n\t\t\tapp.updateUserStatus($('.chats-list [data-uid=\"' + data.uid + '\"] [component=\"user/status\"]'), data.status);\n\t\t});\n\n\t\tmessages.onChatMessageEdit();\n\n\t\tsocket.on('event:chats.roomRename', function (data) {\n\t\t\tvar roomEl = components.get('chat/recent/room', data.roomId);\n\t\t\tvar titleEl = roomEl.find('[component=\"chat/title\"]');\n\t\t\tajaxify.data.roomName = data.newName;\n\n\t\t\ttitleEl.text(data.newName);\n\t\t});\n\t};\n\n\tChats.resizeMainWindow = function () {\n\t\tvar viewportHeight = $(window).height();\n\t\tvar fromTop = components.get('chat/main-wrapper').offset().top || components.get('chat/nav-wrapper').offset().top;\n\t\t$('.chats-full').height(viewportHeight - fromTop - 1);\n\n\t\tChats.setActive();\n\t};\n\n\tChats.setActive = function () {\n\t\tif (ajaxify.data.roomId) {\n\t\t\tsocket.emit('modules.chats.markRead', ajaxify.data.roomId);\n\t\t\t$('[data-roomid=\"' + ajaxify.data.roomId + '\"]').toggleClass('unread', false);\n\t\t\t$('.expanded-chat [component=\"chat/input\"]').focus();\n\t\t}\n\t\t$('.chats-list li').removeClass('bg-info');\n\t\t$('.chats-list li[data-roomid=\"' + ajaxify.data.roomId + '\"]').addClass('bg-info');\n\n\t\tcomponents.get('chat/nav-wrapper').attr('data-loaded', ajaxify.data.roomId ? '1' : '0');\n\t};\n\n\n\treturn Chats;\n});\n"]}