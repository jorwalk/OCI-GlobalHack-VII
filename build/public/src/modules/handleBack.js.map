{"version":3,"sources":["public/src/modules/handleBack.js"],"names":["define","components","storage","navigator","pagination","handleBack","loadTopicsMethod","init","_loadTopicsMethod","saveClickedIndex","$","window","off","onBackClicked","on","clickedIndex","this","parents","attr","each","index","el","offset","top","scrollTop","setItem","ajaxify","data","template","category","recent","bookmarkIndex","getItem","removeItem","Math","max","parseInt","utils","isNumber","config","usePagination","page","ceil","topicsPerPage","currentPage","loadPage","scrollToTopic","highlightTopic","empty","one","topicIndex","highlight","get","length","hasClass","addClass","setTimeout","removeClass","duration","scrollTo","animate","undefined","update"],"mappings":"AAAA,aAEAA,OAAO,cACN,aACA,UACA,YACA,oBACE,SAAUC,EAAYC,EAASC,EAAWC,GAC5C,IAAIC,KACJ,IAAIC,EAEJD,EAAWE,KAAO,SAAUC,GAC3BF,EAAmBE,EACnBC,IACAC,EAAEC,QAAQC,IAAI,kBAAmBC,GAAeC,GAAG,kBAAmBD,IAGvE,SAASJ,IACRC,EAAE,0BAA0BI,GAAG,QAAS,6BAA8B,WACrE,IAAIC,EAAeL,EAAEM,MAAMC,QAAQ,gBAAgBC,KAAK,cACxDR,EAAE,gCAAgCS,KAAK,SAAUC,EAAOC,GACvD,GAAIX,EAAEW,GAAIC,SAASC,IAAMb,EAAEC,QAAQa,YAAc,EAAG,CACnDtB,EAAQuB,QAAQ,oBAAqBf,EAAEW,GAAIH,KAAK,eAChDhB,EAAQuB,QAAQ,4BAA6BV,GAC7C,OAAO,WAMX,SAASF,IACR,GAAKa,QAAQC,KAAKC,SAASC,UAAYH,QAAQC,KAAKC,SAASE,OAAS,CACrE,IAAIC,EAAgB7B,EAAQ8B,QAAQ,qBACpC,IAAIjB,EAAeb,EAAQ8B,QAAQ,6BAEnC9B,EAAQ+B,WAAW,qBACnB/B,EAAQ+B,WAAW,6BAEnBF,EAAgBG,KAAKC,IAAI,EAAGC,SAASL,EAAe,KAAO,GAC3DhB,EAAemB,KAAKC,IAAI,EAAGC,SAASrB,EAAc,KAAO,GACzD,IAAKsB,MAAMC,SAASP,GAAgB,CACnC,OAGD,GAAIQ,OAAOC,cAAe,CACzB,IAAIC,EAAOP,KAAKQ,MAAMN,SAASL,EAAe,IAAM,GAAKQ,OAAOI,eAChE,GAAIP,SAASK,EAAM,MAAQf,QAAQC,KAAKvB,WAAWwC,YAAa,CAC/DxC,EAAWyC,SAASJ,EAAM,WACzBpC,EAAWyC,cAAcf,EAAehB,EAAc,SAEjD,CACNV,EAAWyC,cAAcf,EAAehB,EAAc,QAEjD,CACN,GAAIgB,IAAkB,EAAG,CACxB1B,EAAW0C,eAAehC,GAC1B,OAGDL,EAAE,0BAA0BsC,QAC5B1C,EAAiB4B,KAAKC,IAAI,EAAGJ,EAAgB,GAAK,EAAG,WACpDrB,EAAEC,QAAQsC,IAAI,uBAAwB,WACrC5C,EAAWyC,cAAcf,EAAehB,EAAc,SAO3DV,EAAW0C,eAAiB,SAAUG,GACrC,IAAIC,EAAYlD,EAAWmD,IAAI,iBAAkB,QAASF,GAE1D,GAAIC,EAAUE,SAAWF,EAAUG,SAAS,aAAc,CACzDH,EAAUI,SAAS,aACnBC,WAAW,WACVL,EAAUM,YAAY,cACpB,OAILpD,EAAWyC,cAAgB,SAAUf,EAAehB,EAAc2C,EAAUpC,GAC3E,IAAKe,MAAMC,SAASP,GAAgB,CACnC,OAGD,IAAKT,EAAQ,CACZA,EAAS,EAGV,IAAIqC,EAAW1D,EAAWmD,IAAI,iBAAkB,QAASrB,GAEzD,GAAI4B,EAASN,OAAQ,CACpB3C,EAAE,cAAckD,SACfpC,UAAYmC,EAASrC,SAASC,IAAMD,EAAU,MAC5CoC,IAAaG,UAAYH,EAAW,IAAK,WAC3CrD,EAAW0C,eAAehC,GAC1BZ,EAAU2D,aAKb,OAAOzD","file":"public/src/modules/handleBack.js","sourcesContent":["'use strict';\n\ndefine('handleBack', [\n\t'components',\n\t'storage',\n\t'navigator',\n\t'forum/pagination',\n], function (components, storage, navigator, pagination) {\n\tvar handleBack = {};\n\tvar loadTopicsMethod;\n\n\thandleBack.init = function (_loadTopicsMethod) {\n\t\tloadTopicsMethod = _loadTopicsMethod;\n\t\tsaveClickedIndex();\n\t\t$(window).off('action:popstate', onBackClicked).on('action:popstate', onBackClicked);\n\t};\n\n\tfunction saveClickedIndex() {\n\t\t$('[component=\"category\"]').on('click', '[component=\"topic/header\"]', function () {\n\t\t\tvar clickedIndex = $(this).parents('[data-index]').attr('data-index');\n\t\t\t$('[component=\"category/topic\"]').each(function (index, el) {\n\t\t\t\tif ($(el).offset().top - $(window).scrollTop() > 0) {\n\t\t\t\t\tstorage.setItem('category:bookmark', $(el).attr('data-index'));\n\t\t\t\t\tstorage.setItem('category:bookmark:clicked', clickedIndex);\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tfunction onBackClicked() {\n\t\tif ((ajaxify.data.template.category || ajaxify.data.template.recent)) {\n\t\t\tvar bookmarkIndex = storage.getItem('category:bookmark');\n\t\t\tvar clickedIndex = storage.getItem('category:bookmark:clicked');\n\n\t\t\tstorage.removeItem('category:bookmark');\n\t\t\tstorage.removeItem('category:bookmark:clicked');\n\n\t\t\tbookmarkIndex = Math.max(0, parseInt(bookmarkIndex, 10) || 0);\n\t\t\tclickedIndex = Math.max(0, parseInt(clickedIndex, 10) || 0);\n\t\t\tif (!utils.isNumber(bookmarkIndex)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (config.usePagination) {\n\t\t\t\tvar page = Math.ceil((parseInt(bookmarkIndex, 10) + 1) / config.topicsPerPage);\n\t\t\t\tif (parseInt(page, 10) !== ajaxify.data.pagination.currentPage) {\n\t\t\t\t\tpagination.loadPage(page, function () {\n\t\t\t\t\t\thandleBack.scrollToTopic(bookmarkIndex, clickedIndex, 0);\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\thandleBack.scrollToTopic(bookmarkIndex, clickedIndex, 0);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (bookmarkIndex === 0) {\n\t\t\t\t\thandleBack.highlightTopic(clickedIndex);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t$('[component=\"category\"]').empty();\n\t\t\t\tloadTopicsMethod(Math.max(0, bookmarkIndex - 1) + 1, function () {\n\t\t\t\t\t$(window).one('action:topics.loaded', function () {\n\t\t\t\t\t\thandleBack.scrollToTopic(bookmarkIndex, clickedIndex, 0);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\thandleBack.highlightTopic = function (topicIndex) {\n\t\tvar highlight = components.get('category/topic', 'index', topicIndex);\n\n\t\tif (highlight.length && !highlight.hasClass('highlight')) {\n\t\t\thighlight.addClass('highlight');\n\t\t\tsetTimeout(function () {\n\t\t\t\thighlight.removeClass('highlight');\n\t\t\t}, 5000);\n\t\t}\n\t};\n\n\thandleBack.scrollToTopic = function (bookmarkIndex, clickedIndex, duration, offset) {\n\t\tif (!utils.isNumber(bookmarkIndex)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!offset) {\n\t\t\toffset = 0;\n\t\t}\n\n\t\tvar scrollTo = components.get('category/topic', 'index', bookmarkIndex);\n\n\t\tif (scrollTo.length) {\n\t\t\t$('html, body').animate({\n\t\t\t\tscrollTop: (scrollTo.offset().top - offset) + 'px',\n\t\t\t}, duration !== undefined ? duration : 400, function () {\n\t\t\t\thandleBack.highlightTopic(clickedIndex);\n\t\t\t\tnavigator.update();\n\t\t\t});\n\t\t}\n\t};\n\n\treturn handleBack;\n});\n"]}