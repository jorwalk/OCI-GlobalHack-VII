{"version":3,"sources":["node_modules/nodebb-plugin-composer-default/static/lib/composer/uploads.js"],"names":["define","preview","categoryList","translator","uploads","inProgress","uploadingText","initialize","post_uuid","initializeDragAndDrop","initializePaste","addChangeHandlers","addTopicThumbHandlers","translate","translated","postContainer","$","find","on","e","files","target","this","val","name","type","utils","fileMimeType","uploadContentFiles","route","fd","window","FormData","i","length","append","uploadTopicThumb","formData","trigger","resetInputFile","addClass","preventDefault","urlEl","setTimeout","url","removeClass","attr","toggleThumbEls","thumbToggleBtnEl","off","container","toggleClass","hasClass","$el","wrap","closest","get","reset","unwrap","onDragEnter","draggingDocument","drop","css","height","show","hide","onDragDrop","originalEvent","dataTransfer","cancel","document","event","items","clipboardData","some","call","item","blob","getAsFile","blobName","generateUUID","fileNames","escapeRegExp","text","replace","insertText","str","index","insert","slice","params","textarea","uploadForm","doneUploading","config","relative_path","cid","getSelectedCid","ajaxify","data","isImage","match","app","user","privileges","alertError","filenameMapping","push","Date","now","size","parseInt","maximumFileSize","getCursorPosition","prop","submit","updateTextArea","filename","current","re","RegExp","ajaxSubmit","headers","x-csrf-token","csrf_token","resetForm","clearForm","error","xhr","onUploadError","uploadProgress","position","total","percent","success","render","focus","complete","pop","spinner","thumbForm","msg","responseJSON","status","statusText"],"mappings":"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","file":"node_modules/nodebb-plugin-composer-default/static/lib/composer/uploads.js","sourcesContent":["'use strict';\n\n/* globals define, utils, config, app */\n\ndefine('composer/uploads', [\n\t'composer/preview',\n\t'composer/categoryList',\n\t'translator',\n], function(preview, categoryList, translator) {\n\tvar uploads = {\n\t\tinProgress: {}\n\t};\n\n\tvar uploadingText = '';\n\n\tuploads.initialize = function(post_uuid) {\n\t\tinitializeDragAndDrop(post_uuid);\n\t\tinitializePaste(post_uuid);\n\n\t\taddChangeHandlers(post_uuid);\n\t\taddTopicThumbHandlers(post_uuid);\n\t\ttranslator.translate('[[modules:composer.uploading, ' + 0 + '%]]', function(translated) {\n\t\t\tuploadingText = translated;\n\t\t});\n\t};\n\n\tfunction addChangeHandlers(post_uuid) {\n\t\tvar postContainer = $('.composer[data-uuid=\"' + post_uuid + '\"]');\n\n\t\tpostContainer.find('#files').on('change', function(e) {\n\t\t\tvar files = (e.target || {}).files || ($(this).val() ? [{name: $(this).val(), type: utils.fileMimeType($(this).val())}] : null);\n\t\t\tif (files) {\n\t\t\t\tuploadContentFiles({files: files, post_uuid: post_uuid, route: '/api/post/upload'});\n\t\t\t}\n\t\t});\n\n\t\tpostContainer.find('#topic-thumb-file').on('change', function(e) {\n\t\t\tvar files = (e.target || {}).files || ($(this).val() ? [{name: $(this).val(), type: utils.fileMimeType($(this).val())}] : null),\n\t\t\t\tfd;\n\n\t\t\tif (files) {\n\t\t\t\tif (window.FormData) {\n\t\t\t\t\tfd = new FormData();\n\t\t\t\t\tfor (var i = 0; i < files.length; ++i) {\n\t\t\t\t\t\tfd.append('files[]', files[i], files[i].name);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tuploadTopicThumb({files: files, post_uuid: post_uuid, route: '/api/topic/thumb/upload', formData: fd});\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction addTopicThumbHandlers(post_uuid) {\n\t\tvar postContainer = $('.composer[data-uuid=\"' + post_uuid + '\"]');\n\n\t\tpostContainer.on('click', '.topic-thumb-clear-btn', function(e) {\n\t\t\tpostContainer.find('input#topic-thumb-url').val('').trigger('change');\n\t\t\tresetInputFile(postContainer.find('input#topic-thumb-file'));\n\t\t\t$(this).addClass('hide');\n\t\t\te.preventDefault();\n\t\t});\n\n\t\tpostContainer.on('paste change keypress', 'input#topic-thumb-url', function() {\n\t\t\tvar urlEl = $(this);\n\t\t\tsetTimeout(function(){\n\t\t\t\tvar url = urlEl.val();\n\t\t\t\tif (url) {\n\t\t\t\t\tpostContainer.find('.topic-thumb-clear-btn').removeClass('hide');\n\t\t\t\t} else {\n\t\t\t\t\tresetInputFile(postContainer.find('input#topic-thumb-file'));\n\t\t\t\t\tpostContainer.find('.topic-thumb-clear-btn').addClass('hide');\n\t\t\t\t}\n\t\t\t\tpostContainer.find('img.topic-thumb-preview').attr('src', url);\n\t\t\t}, 100);\n\t\t});\n\t}\n\n\tuploads.toggleThumbEls = function(postContainer, url) {\n\t\tvar thumbToggleBtnEl = postContainer.find('.topic-thumb-toggle-btn');\n\n\t\tpostContainer.find('input#topic-thumb-url').val(url);\n\t\tpostContainer.find('img.topic-thumb-preview').attr('src', url);\n\t\tif (url) {\n\t\t\tpostContainer.find('.topic-thumb-clear-btn').removeClass('hide');\n\t\t}\n\t\tthumbToggleBtnEl.removeClass('hide');\n\t\tthumbToggleBtnEl.off('click').on('click', function() {\n\t\t\tvar container = postContainer.find('.topic-thumb-container');\n\t\t\tcontainer.toggleClass('hide', !container.hasClass('hide'));\n\t\t});\n\t};\n\n\tfunction resetInputFile($el) {\n\t\t$el.wrap('<form />').closest('form').get(0).reset();\n\t\t$el.unwrap();\n\t}\n\n\tfunction initializeDragAndDrop(post_uuid) {\n\n\t\tfunction onDragEnter() {\n\t\t\tif (draggingDocument) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tdrop.css('top', '0px');\n\t\t\tdrop.css('height', postContainer.height() + 'px');\n\t\t\tdrop.css('line-height', postContainer.height() + 'px');\n\t\t\tdrop.show();\n\n\t\t\tdrop.on('dragleave', function() {\n\t\t\t\tdrop.hide();\n\t\t\t\tdrop.off('dragleave');\n\t\t\t});\n\t\t}\n\n\t\tfunction onDragDrop(e) {\n\t\t\te.preventDefault();\n\t\t\tvar files = e.originalEvent.dataTransfer.files;\n\t\t\tvar fd;\n\n\t\t\tif (files.length) {\n\t\t\t\tif (window.FormData) {\n\t\t\t\t\tfd = new FormData();\n\t\t\t\t\tfor (var i = 0; i < files.length; ++i) {\n\t\t\t\t\t\tfd.append('files[]', files[i], files[i].name);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tuploadContentFiles({\n\t\t\t\t\tfiles: files,\n\t\t\t\t\tpost_uuid: post_uuid,\n\t\t\t\t\troute: '/api/post/upload',\n\t\t\t\t\tformData: fd\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tdrop.hide();\n\t\t\treturn false;\n\t\t}\n\n\t\tfunction cancel(e) {\n\t\t\te.preventDefault();\n\t\t\treturn false;\n\t\t}\n\n\t\tvar draggingDocument = false;\n\n\t\tvar postContainer = $('.composer[data-uuid=\"' + post_uuid + '\"]');\n\t\tvar drop = postContainer.find('.imagedrop');\n\n\t\t$(document).off('dragstart').on('dragstart', function() {\n\t\t\tdraggingDocument = true;\n\t\t}).off('dragend').on('dragend', function() {\n\t\t\tdraggingDocument = false;\n\t\t});\n\n\t\tpostContainer.on('dragenter', onDragEnter);\n\n\t\tdrop.on('dragover', cancel);\n\t\tdrop.on('dragenter', cancel);\n\t\tdrop.on('drop', onDragDrop);\n\t}\n\n\tfunction initializePaste(post_uuid) {\n\t\tvar postContainer = $('.composer[data-uuid=\"' + post_uuid + '\"]');\n\t\tpostContainer.on('paste', function(event) {\n\t\t\tvar items = (event.clipboardData || event.originalEvent.clipboardData || {}).items;\n\n\t\t\t[].some.call(items, function(item) {\n\t\t\t\tvar blob = item.getAsFile();\n\n\t\t\t\tif (!blob) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar blobName = utils.generateUUID() + '-' + blob.name;\n\n\t\t\t\tvar fd = null;\n\t\t\t\tif (window.FormData) {\n\t\t\t\t\tfd = new FormData();\n\t\t\t\t\tfd.append('files[]', blob, blobName);\n\t\t\t\t}\n\n\t\t\t\tuploadContentFiles({\n\t\t\t\t\tfiles: [blob],\n\t\t\t\t\tfileNames: [blobName],\n\t\t\t\t\tpost_uuid: post_uuid,\n\t\t\t\t\troute: '/api/post/upload',\n\t\t\t\t\tformData: fd\n\t\t\t\t});\n\n\t\t\t\treturn true;\n\t\t\t});\n\t\t});\n\t}\n\n\tfunction escapeRegExp(text) {\n\t\treturn text.replace(/[-[\\]{}()*+?.,\\\\^$|#\\s]/g, \"\\\\$&\");\n\t}\n\n\tfunction insertText(str, index, insert) {\n\t\treturn str.slice(0, index) + insert + str.slice(index);\n\t}\n\n\tfunction uploadContentFiles(params) {\n\t\tvar files = params.files;\n\t\tvar post_uuid = params.post_uuid;\n\t\tvar postContainer = $('.composer[data-uuid=\"' + post_uuid + '\"]');\n\t\tvar textarea = postContainer.find('textarea');\n\t\tvar text = textarea.val();\n\t\tvar uploadForm = postContainer.find('#fileForm');\n\t\tvar doneUploading = false;\n\t\tuploadForm.attr('action', config.relative_path + params.route);\n\n\t\tvar cid = categoryList.getSelectedCid();\n\t\tif (!cid && ajaxify.data.cid) {\n\t\t\tcid = ajaxify.data.cid;\n\t\t}\n\n\t\tfor (var i = 0; i < files.length; ++i) {\n\t\t\tvar isImage = files[i].type.match(/image./);\n\t\t\tif ((isImage && !app.user.privileges['upload:post:image']) || (!isImage && !app.user.privileges['upload:post:file'])) {\n\t\t\t\treturn app.alertError('[[error:no-privileges]]');\n\t\t\t}\n\t\t}\n\n\t\tvar filenameMapping = [];\n\n\t\tfor (var i = 0; i < files.length; ++i) {\n\t\t\tfilenameMapping.push(i + '_' + Date.now() + '_' + (params.fileNames ? params.fileNames[i] : files[i].name));\n\t\t\tvar isImage = files[i].type.match(/image./);\n\n\t\t\tif (files[i].size > parseInt(config.maximumFileSize, 10) * 1024) {\n\t\t\t\tuploadForm[0].reset();\n\t\t\t\treturn app.alertError('[[error:file-too-big, ' + config.maximumFileSize + ']]');\n\t\t\t}\n\n\t\t\ttext = insertText(text, textarea.getCursorPosition(), (isImage ? '!' : '') + '[' + filenameMapping[i] + '](' + uploadingText + ') ');\n\t\t}\n\t\tpostContainer.find('[data-action=\"post\"]').prop('disabled', true);\n\t\ttextarea.val(text);\n\n\t\tuploadForm.off('submit').submit(function() {\n\t\t\tfunction updateTextArea(filename, text) {\n\t\t\t\tvar current = textarea.val();\n\t\t\t\tvar re = new RegExp(escapeRegExp(filename) + \"]\\\\([^)]+\\\\)\", 'g');\n\t\t\t\ttextarea.val(current.replace(re, filename + '](' + text + ')'));\n\t\t\t}\n\n\t\t\tuploads.inProgress[post_uuid] = uploads.inProgress[post_uuid] || [];\n\t\t\tuploads.inProgress[post_uuid].push(1);\n\n\t\t\tif (params.formData) {\n\t\t\t\tparams.formData.append('cid', cid);\n\t\t\t}\n\n\t\t\t$(this).ajaxSubmit({\n\t\t\t\theaders: {\n\t\t\t\t\t'x-csrf-token': config.csrf_token\n\t\t\t\t},\n\t\t\t\tresetForm: true,\n\t\t\t\tclearForm: true,\n\t\t\t\tformData: params.formData,\n\t\t\t\tdata: { cid: cid },\n\n\t\t\t\terror: function (xhr) {\n\t\t\t\t\tpostContainer.find('[data-action=\"post\"]').prop('disabled', false);\n\t\t\t\t\tonUploadError(xhr);\n\t\t\t\t},\n\n\t\t\t\tuploadProgress: function(event, position, total, percent) {\n\t\t\t\t\ttranslator.translate('[[modules:composer.uploading, ' + percent + '%]]', function(translated) {\n\t\t\t\t\t\tif (doneUploading) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tfor (var i=0; i < files.length; ++i) {\n\t\t\t\t\t\t\tupdateTextArea(filenameMapping[i], translated);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t},\n\n\t\t\t\tsuccess: function(uploads) {\n\t\t\t\t\tdoneUploading = true;\n\t\t\t\t\tif (uploads && uploads.length) {\n\t\t\t\t\t\tfor (var i=0; i<uploads.length; ++i) {\n\t\t\t\t\t\t\tupdateTextArea(filenameMapping[i], uploads[i].url);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tpreview.render(postContainer);\n\t\t\t\t\ttextarea.focus();\n\t\t\t\t\tpostContainer.find('[data-action=\"post\"]').prop('disabled', false);\n\t\t\t\t},\n\n\t\t\t\tcomplete: function() {\n\t\t\t\t\tuploadForm[0].reset();\n\t\t\t\t\tuploads.inProgress[post_uuid].pop();\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treturn false;\n\t\t});\n\n\t\tuploadForm.submit();\n\t}\n\n\tfunction uploadTopicThumb(params) {\n\t\tvar post_uuid = params.post_uuid,\n\t\t\tpostContainer = $('.composer[data-uuid=\"' + post_uuid + '\"]'),\n\t\t\tspinner = postContainer.find('.topic-thumb-spinner'),\n\t\t\tthumbForm = postContainer.find('#thumbForm');\n\n\t\tthumbForm.attr('action', config.relative_path + params.route);\n\n\t\tthumbForm.off('submit').submit(function() {\n\t\t\tspinner.removeClass('hide');\n\n\t\t\tuploads.inProgress[post_uuid] = uploads.inProgress[post_uuid] || [];\n\t\t\tuploads.inProgress[post_uuid].push(1);\n\n\t\t\t$(this).ajaxSubmit({\n\t\t\t\theaders: {\n\t\t\t\t\t'x-csrf-token': config.csrf_token\n\t\t\t\t},\n\t\t\t\tformData: params.formData,\n\t\t\t\terror: onUploadError,\n\t\t\t\tsuccess: function(uploads) {\n\t\t\t\t\tpostContainer.find('#topic-thumb-url').val((uploads[0] || {}).url || '').trigger('change');\n\t\t\t\t},\n\t\t\t\tcomplete: function() {\n\t\t\t\t\tuploads.inProgress[post_uuid].pop();\n\t\t\t\t\tspinner.addClass('hide');\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn false;\n\t\t});\n\t\tthumbForm.submit();\n\t}\n\n\tfunction onUploadError(xhr) {\n\t\tvar msg = (xhr.responseJSON && xhr.responseJSON.error) || '[[error:parse-error]]';\n\t\tif (xhr && xhr.status === 413) {\n\t\t\tmsg = xhr.statusText || 'Request Entity Too Large';\n\t\t}\n\t\tapp.alertError(msg);\n\t}\n\n\treturn uploads;\n});\n\n"]}