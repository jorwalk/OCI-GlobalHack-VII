{"version":3,"sources":["public/src/modules/notifications.js"],"names":["define","sounds","translator","components","navigator","Benchpress","Notifications","unreadNotifs","prepareDOM","notifContainer","get","notifTrigger","children","notifList","notifDropdownWrapper","parents","on","e","preventDefault","hasClass","loadNotifications","ev","notifEl","$","this","scrollToPostIndexIfOnPage","stopPropagation","dropdown","unread","nid","attr","markNotification","markAllRead","liEl","parent","toggleClass","socket","notifData","payload","alert_id","title","timeout","parseInt","config","notificationAlertTimeout","path","message","bodyShort","type","clickfn","startsWith","window","location","href","protocol","host","relative_path","app","alert","refreshTitle","ajaxify","currentPage","refresh","emit","err","count","alertError","updateNotifCount","play","read","callback","pid","postEl","length","data","template","topic","scrollToIndex","notifs","concat","sort","a","b","datetime","toggleTimeagoShorthand","i","timeago","Date","parse","notifications","html","translateHtml","notifIcon","Math","max","removeClass","addClass","updateFavicon","trigger","Tinycon","setBubble"],"mappings":"AAAA,aAGAA,OAAO,iBAAkB,SAAU,aAAc,aAAc,YAAa,cAAe,SAAUC,EAAQC,EAAYC,EAAYC,EAAWC,GAC/I,IAAIC,KAEJ,IAAIC,KAEJD,EAAcE,WAAa,WAC1B,IAAIC,EAAiBN,EAAWO,IAAI,iBACpC,IAAIC,EAAeF,EAAeG,SAAS,KAC3C,IAAIC,EAAYV,EAAWO,IAAI,sBAC/B,IAAII,EAAuBH,EAAaI,QAAQ,aAEhDJ,EAAaK,GAAG,QAAS,SAAUC,GAClCA,EAAEC,iBACF,GAAIT,EAAeU,SAAS,QAAS,CACpC,OAGDb,EAAcc,kBAAkBP,KAGjC,GAAIC,EAAqBK,SAAS,QAAS,CAC1Cb,EAAcc,kBAAkBP,GAGjCA,EAAUG,GAAG,QAAS,aAAc,SAAUK,GAC7C,IAAIC,EAAUC,EAAEC,MAChB,GAAIC,EAA0BH,GAAU,CACvCD,EAAGK,kBACHL,EAAGH,iBACHP,EAAagB,SAAS,UAGvB,IAAIC,EAASN,EAAQH,SAAS,UAC9B,IAAKS,EAAQ,CACZ,OAED,IAAIC,EAAMP,EAAQQ,KAAK,YACvBC,EAAiBF,EAAK,QAGvBpB,EAAeO,GAAG,QAAS,iBAAkBV,EAAc0B,aAE3DnB,EAAUG,GAAG,QAAS,aAAc,WACnC,IAAIiB,EAAOV,EAAEC,MAAMU,SACnB,IAAIN,EAASK,EAAKd,SAAS,UAC3B,IAAIU,EAAMI,EAAKH,KAAK,YACpBC,EAAiBF,EAAKD,EAAQ,WAC7BK,EAAKE,YAAY,YAElB,OAAO,QAGRC,OAAOpB,GAAG,yBAA0B,SAAUqB,GAE7C,IAAIC,GACHC,SAAU,YACVC,MAAO,qCACPC,QAASC,SAASC,OAAOC,yBAA0B,KAAO,KAG3D,GAAIP,EAAUQ,KAAM,CACnBP,EAAQQ,QAAUT,EAAUU,UAC5BT,EAAQU,KAAO,OACfV,EAAQW,QAAU,WACjBlB,EAAiBM,EAAUR,IAAK,MAChC,GAAIQ,EAAUQ,KAAKK,WAAW,SAAWb,EAAUQ,KAAKK,WAAW,SAAU,CAC5EC,OAAOC,SAASC,KAAOhB,EAAUQ,SAC3B,CACNM,OAAOC,SAASC,KAAOF,OAAOC,SAASE,SAAW,KAAOH,OAAOC,SAASG,KAAOZ,OAAOa,cAAgBnB,EAAUQ,WAG7G,CACNP,EAAQQ,QAAU,kDAClBR,EAAQU,KAAO,UAGhBS,IAAIC,MAAMpB,GACVmB,IAAIE,eAEJ,GAAIC,QAAQC,cAAgB,gBAAiB,CAC5CD,QAAQE,UAGT1B,OAAO2B,KAAK,yBAA0B,SAAUC,EAAKC,GACpD,GAAID,EAAK,CACR,OAAOP,IAAIS,WAAWF,EAAIlB,SAG3BxC,EAAc6D,iBAAiBF,KAGhC,IAAK1D,EAAa8B,EAAUR,KAAM,CACjC5B,EAAOmE,KAAK,eAAgB/B,EAAUR,KACtCtB,EAAa8B,EAAUR,KAAO,QAIhCO,OAAOpB,GAAG,kCAAmC,SAAUiD,GACtD3D,EAAc6D,iBAAiBF,MAIjC,SAASlC,EAAiBF,EAAKwC,EAAMC,GACpClC,OAAO2B,KAAK,sBAAwBM,EAAO,OAAS,UAAWxC,EAAK,SAAUmC,GAC7E,GAAIA,EAAK,CACR,OAAOP,IAAIS,WAAWF,EAAIlB,SAG3B,GAAIuB,GAAQ9D,EAAasB,GAAM,QACvBtB,EAAasB,GAErB,GAAIyC,EAAU,CACbA,OAKH,SAAS7C,EAA0BH,GAElC,IAAIiD,EAAMjD,EAAQQ,KAAK,YACvB,IAAIe,EAAOvB,EAAQQ,KAAK,aACxB,IAAI0C,EAASrE,EAAWO,IAAI,OAAQ,MAAO6D,GAC3C,GAAI1B,EAAKK,WAAWP,OAAOa,cAAgB,WAAae,GAAOC,EAAOC,QAAUb,QAAQc,KAAKC,SAASC,MAAO,CAC5GxE,EAAUyE,cAAcL,EAAO1C,KAAK,cAAe,MACnD,OAAO,KAER,OAAO,MAGRxB,EAAcc,kBAAoB,SAAUP,GAC3CuB,OAAO2B,KAAK,oBAAqB,KAAM,SAAUC,EAAKU,GACrD,GAAIV,EAAK,CACR,OAAOP,IAAIS,WAAWF,EAAIlB,SAG3B,IAAIgC,EAASJ,EAAK9C,OAAOmD,OAAOL,EAAKL,MAAMW,KAAK,SAAUC,EAAGC,GAC5D,OAAOxC,SAASuC,EAAEE,SAAU,IAAMzC,SAASwC,EAAEC,SAAU,KAAO,EAAI,IAGnEjF,EAAWkF,uBAAuB,WACjC,IAAK,IAAIC,EAAI,EAAGA,EAAIP,EAAOL,OAAQY,GAAK,EAAG,CAC1CP,EAAOO,GAAGC,QAAU/D,EAAE+D,QAAQ,IAAIC,KAAK7C,SAASoC,EAAOO,GAAGF,SAAU,MAErEjF,EAAWkF,yBACX/E,EAAWmF,MAAM,+BAAiCC,cAAeX,GAAU,SAAUY,GACpF7E,EAAU8E,cAAcD,UAM5BpF,EAAc6D,iBAAmB,SAAUF,GAC1C,IAAI2B,EAAYzF,EAAWO,IAAI,sBAC/BuD,EAAQ4B,KAAKC,IAAI,EAAG7B,GACpB,GAAIA,EAAQ,EAAG,CACd2B,EAAUG,YAAY,aAAaC,SAAS,eACtC,CACNJ,EAAUG,YAAY,WAAWC,SAAS,aAG3CJ,EAAUzD,YAAY,eAAgB8B,EAAQ,GAC9C2B,EAAU9D,KAAK,eAAgBmC,EAAQ,GAAK,MAAQA,GAEpD,IAAI3B,GACH2B,MAAOA,EACPgC,cAAe,MAEhB1E,EAAE4B,QAAQ+C,QAAQ,kCAAmC5D,GAErD,GAAIA,EAAQ2D,cAAe,CAC1BE,QAAQC,UAAUnC,EAAQ,GAAK,MAAQA,KAIzC3D,EAAc0B,YAAc,WAC3BI,OAAO2B,KAAK,4BAA6B,SAAUC,GAClD,GAAIA,EAAK,CACRP,IAAIS,WAAWF,EAAIlB,SAEpBvC,QAIF,OAAOD","file":"public/src/modules/notifications.js","sourcesContent":["'use strict';\n\n\ndefine('notifications', ['sounds', 'translator', 'components', 'navigator', 'benchpress'], function (sounds, translator, components, navigator, Benchpress) {\n\tvar Notifications = {};\n\n\tvar unreadNotifs = {};\n\n\tNotifications.prepareDOM = function () {\n\t\tvar notifContainer = components.get('notifications');\n\t\tvar notifTrigger = notifContainer.children('a');\n\t\tvar notifList = components.get('notifications/list');\n\t\tvar notifDropdownWrapper = notifTrigger.parents('.dropdown');\n\n\t\tnotifTrigger.on('click', function (e) {\n\t\t\te.preventDefault();\n\t\t\tif (notifContainer.hasClass('open')) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tNotifications.loadNotifications(notifList);\n\t\t});\n\n\t\tif (notifDropdownWrapper.hasClass('open')) {\n\t\t\tNotifications.loadNotifications(notifList);\n\t\t}\n\n\t\tnotifList.on('click', '[data-nid]', function (ev) {\n\t\t\tvar notifEl = $(this);\n\t\t\tif (scrollToPostIndexIfOnPage(notifEl)) {\n\t\t\t\tev.stopPropagation();\n\t\t\t\tev.preventDefault();\n\t\t\t\tnotifTrigger.dropdown('toggle');\n\t\t\t}\n\n\t\t\tvar unread = notifEl.hasClass('unread');\n\t\t\tif (!unread) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar nid = notifEl.attr('data-nid');\n\t\t\tmarkNotification(nid, true);\n\t\t});\n\n\t\tnotifContainer.on('click', '.mark-all-read', Notifications.markAllRead);\n\n\t\tnotifList.on('click', '.mark-read', function () {\n\t\t\tvar liEl = $(this).parent();\n\t\t\tvar unread = liEl.hasClass('unread');\n\t\t\tvar nid = liEl.attr('data-nid');\n\t\t\tmarkNotification(nid, unread, function () {\n\t\t\t\tliEl.toggleClass('unread');\n\t\t\t});\n\t\t\treturn false;\n\t\t});\n\n\t\tsocket.on('event:new_notification', function (notifData) {\n\t\t\t// If a path is defined, show notif data, otherwise show generic data\n\t\t\tvar payload = {\n\t\t\t\talert_id: 'new_notif',\n\t\t\t\ttitle: '[[notifications:new_notification]]',\n\t\t\t\ttimeout: parseInt(config.notificationAlertTimeout, 10) || 5000,\n\t\t\t};\n\n\t\t\tif (notifData.path) {\n\t\t\t\tpayload.message = notifData.bodyShort;\n\t\t\t\tpayload.type = 'info';\n\t\t\t\tpayload.clickfn = function () {\n\t\t\t\t\tmarkNotification(notifData.nid, true);\n\t\t\t\t\tif (notifData.path.startsWith('http') || notifData.path.startsWith('https')) {\n\t\t\t\t\t\twindow.location.href = notifData.path;\n\t\t\t\t\t} else {\n\t\t\t\t\t\twindow.location.href = window.location.protocol + '//' + window.location.host + config.relative_path + notifData.path;\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t} else {\n\t\t\t\tpayload.message = '[[notifications:you_have_unread_notifications]]';\n\t\t\t\tpayload.type = 'warning';\n\t\t\t}\n\n\t\t\tapp.alert(payload);\n\t\t\tapp.refreshTitle();\n\n\t\t\tif (ajaxify.currentPage === 'notifications') {\n\t\t\t\tajaxify.refresh();\n\t\t\t}\n\n\t\t\tsocket.emit('notifications.getCount', function (err, count) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\tNotifications.updateNotifCount(count);\n\t\t\t});\n\n\t\t\tif (!unreadNotifs[notifData.nid]) {\n\t\t\t\tsounds.play('notification', notifData.nid);\n\t\t\t\tunreadNotifs[notifData.nid] = true;\n\t\t\t}\n\t\t});\n\n\t\tsocket.on('event:notifications.updateCount', function (count) {\n\t\t\tNotifications.updateNotifCount(count);\n\t\t});\n\t};\n\n\tfunction markNotification(nid, read, callback) {\n\t\tsocket.emit('notifications.mark' + (read ? 'Read' : 'Unread'), nid, function (err) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tif (read && unreadNotifs[nid]) {\n\t\t\t\tdelete unreadNotifs[nid];\n\t\t\t}\n\t\t\tif (callback) {\n\t\t\t\tcallback();\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction scrollToPostIndexIfOnPage(notifEl) {\n\t\t// Scroll to index if already in topic (gh#5873)\n\t\tvar pid = notifEl.attr('data-pid');\n\t\tvar path = notifEl.attr('data-path');\n\t\tvar postEl = components.get('post', 'pid', pid);\n\t\tif (path.startsWith(config.relative_path + '/post/') && pid && postEl.length && ajaxify.data.template.topic) {\n\t\t\tnavigator.scrollToIndex(postEl.attr('data-index'), true);\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tNotifications.loadNotifications = function (notifList) {\n\t\tsocket.emit('notifications.get', null, function (err, data) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tvar notifs = data.unread.concat(data.read).sort(function (a, b) {\n\t\t\t\treturn parseInt(a.datetime, 10) > parseInt(b.datetime, 10) ? -1 : 1;\n\t\t\t});\n\n\t\t\ttranslator.toggleTimeagoShorthand(function () {\n\t\t\t\tfor (var i = 0; i < notifs.length; i += 1) {\n\t\t\t\t\tnotifs[i].timeago = $.timeago(new Date(parseInt(notifs[i].datetime, 10)));\n\t\t\t\t}\n\t\t\t\ttranslator.toggleTimeagoShorthand();\n\t\t\t\tBenchpress.parse('partials/notifications_list', { notifications: notifs }, function (html) {\n\t\t\t\t\tnotifList.translateHtml(html);\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tNotifications.updateNotifCount = function (count) {\n\t\tvar notifIcon = components.get('notifications/icon');\n\t\tcount = Math.max(0, count);\n\t\tif (count > 0) {\n\t\t\tnotifIcon.removeClass('fa-bell-o').addClass('fa-bell');\n\t\t} else {\n\t\t\tnotifIcon.removeClass('fa-bell').addClass('fa-bell-o');\n\t\t}\n\n\t\tnotifIcon.toggleClass('unread-count', count > 0);\n\t\tnotifIcon.attr('data-content', count > 99 ? '99+' : count);\n\n\t\tvar payload = {\n\t\t\tcount: count,\n\t\t\tupdateFavicon: true,\n\t\t};\n\t\t$(window).trigger('action:notification.updateCount', payload);\n\n\t\tif (payload.updateFavicon) {\n\t\t\tTinycon.setBubble(count > 99 ? '99+' : count);\n\t\t}\n\t};\n\n\tNotifications.markAllRead = function () {\n\t\tsocket.emit('notifications.markAllRead', function (err) {\n\t\t\tif (err) {\n\t\t\t\tapp.alertError(err.message);\n\t\t\t}\n\t\t\tunreadNotifs = {};\n\t\t});\n\t};\n\n\treturn Notifications;\n});\n"]}